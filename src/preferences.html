<!doctype html>
<html lang="en">
<head>
	<title>Preferences</title>
	<meta charset="utf-8">
	<meta http-equiv="Content-Security-Policy" content="default-src 'unsafe-inline' *">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" type="text/css" href="preferences.css" />
</head>
<body>
	<div class="preferences">
		<div class="content">
			<div class="row" id="launch-startup-row">
				<label class="label" for="launch-startup">
					<input type="checkbox" id="launch-startup" />
					Launch on Startup
				</label>
			</div>
			<div class="row">
				<label class="label" for="search-types-path">Search Types Path:</label>
				<input type="text" class="text-field search-types-path" id="search-types-path" />
				<button class="button button-standard" id="button-search-types-browse">Browseâ€¦</button>
				<button class="button button-standard" id="button-search-types-open">Open</button>
			</div>
			<div class="row">
				<label class="label" for="search-types-order">Search Types Order:</label>
				<input type="text" class="text-field search-types-order" id="search-types-order" />
				<button class="button button-standard" id="button-search-types-order-reset">Reset</button>
			</div>
			<div class="row">
				<label class="label" for="accelerator-display">Keyboard Shortcut:</label>
				<input type="hidden" class="text-field accelerator" id="accelerator" />
				<input type="text" class="text-field accelerator-display" id="accelerator-display" />
			</div>
			<div id="custom-params" class="custom-params">
			</div>
		</div>

		<div class="buttons">
			<button class="button button-standard" id="button-cancel">Cancel</button>
			<button class="button button-default" id="button-ok">OK</button>
		</div>
	</form>

<script>
(async function() {
	const isMac = navigator.platform.toUpperCase().indexOf('MAC') !== -1;

	function htmlEscape(str) {
		return str ? str
			.replace(/&/g, '&amp;')
			.replace(/"/g, '&quot;')
			.replace(/'/g, '&#39;')
			.replace(/</g, '&lt;')
			.replace(/>/g, '&gt;') : '';
	}

	function getDisplayKeyStr(key) {
		return key
			.replace('lock', 'Lock')
			.replace('numadd', 'Numpad+')
			.replace('numdec', 'Numpad.')
			.replace('numdiv', 'Numpad/')
			.replace('nummult', 'Numpad*')
			.replace('numsub', 'Numpad-')
			.replace('num', 'Numpad')
			.replace('Left', '\u2190')
			.replace('Right', '\u2192')
			.replace('Up', '\u2191')
			.replace('Down', '\u2193')
			.replace('Shift+', isMac ? '\u21E7' : 'Shift+')
			.replace('Control+', isMac ? '\u2303' : 'Ctrl+')
			.replace('Alt+', isMac ? '\u2325' : 'Alt+')
			.replace('Super+', isMac ? '\u2318' : '\u229E');
	
	}

	const codeToElectronKey = {
		'Backquote': '`',
		'Backslash': '\\',
		'Backspace': 'Backspace',
		'BracketLeft': '[',
		'BracketRight': ']',
		'Comma': ',',
		// Digit0-9: 0-9
		'Equal': '=',
		// KeyA-Z: A-Z
		'Minus': '-',
		'Period': '.',
		'Quote': '\'',
		'Semicolon': ';',
		'Slash': '/',
		'CapsLock': 'Capslock',
		'Enter': 'Enter',
		'Space': 'Space',
		'Tab': 'Tab',
		'Delete': 'Delete',
		'End': 'End',
		'Home': 'Home',
		'Insert': 'Insert',
		'PageDown': 'PageDown',
		'PageUp': 'PageUp',
		'ArrowDown': 'Down',
		'ArrowLeft': 'Left',
		'ArrowRight': 'Right',
		'ArrowUp': 'Up',
		'NumLock': 'Numlock',
		// Numpad0-9: num0-9
		'NumpadAdd': 'numadd',
		'NumpadDecimal': 'numdec',
		'NumpadDivide': 'numdiv',
		'NumpadMultiply': 'nummult',
		'NumpadSubtract': 'numsub',
		'Escape': 'Escape',
		// F1-24: F1-24
		'PrintScreen': 'numdec',
		'ScrollLock': 'Scrolllock',
		'MediaPlayPause': 'MediaPlayPause',
		'MediaStop': 'MediaStop',
		'MediaTrackNext': 'MediaNextTrack',
		'MediaTrackPrevious': 'MediaPreviousTrack',
		'AudioVolumeDown': 'VolumeDown',
		'AudioVolumeMute': 'VolumeMute',
		'AudioVolumeUp': 'VolumeUp'
	}

	function browserKeyCodeToElectronKeyCode(code) {
		const electronKey = codeToElectronKey[code];
		if (electronKey !== undefined) {
			return electronKey;
		} else if (code.match(/^Digit\d$/)) {
			return code.substr(5);
		} else if (code.match(/^Key[A-Z]$/)) {
			return code.substr(3);
		} else if (code.match(/^F\d{1,2}$/)) {
			return code;
		} else if (code.match(/^Numpad\d$/)) {
			return 'num' + code.substr(6);
		}
		return null;
	}

	function getKeyStr(e) {
		const keyCode = browserKeyCodeToElectronKeyCode(e.code);
		if (keyCode === null) return null;
		return (e.shiftKey ? 'Shift+' : '')
			+ (e.ctrlKey ? 'Control+' : '')
			+ (e.altKey ? 'Alt+' : '')
			+ (e.metaKey ? 'Super+' : '')
			+ keyCode;
	}

	function refreshCustomParamsFields(searchTypes, customParams) {
		const parent = document.getElementById('custom-params');
		while (parent.firstChild) {
			parent.removeChild(parent.firstChild);
		}
		let idx = 0;
		searchTypes.forEach(searchType => {
			if (!searchType.customParams) return;
			searchType.customParams.forEach(param => {
				let fullName = searchType.id + '.' + param.name;
				let value = '';
				if (customParams && customParams[fullName] !== undefined) value = customParams[fullName];
				else if (!param.password && param.default !== undefined) value = param.default;
				const html = `<div class="row custom-params-row">
					<input type="hidden" class="custom-params-name" value="${htmlEscape(fullName)}" />
					<label class="label" for="custom-params-value-${idx}">${htmlEscape(searchType.name + ' ' + param.label)}:</label>
					<input type="${param.password ? 'password' : 'text'}" class="text-field custom-params-value" id="custom-params-value-${idx}" value="${htmlEscape(value)}" />
				</div>`;
				parent.insertAdjacentHTML('beforeend', html);
				idx++;
			});
		});
		document.getElementById('custom-params').style.display = idx > 0 ? 'block' : 'none'; 
	};

	function getEnteredCustomParams() {
		const customParams = {};
		Array.from(document.getElementsByClassName('custom-params-row')).map(function(row) {
			const name = row.getElementsByClassName('custom-params-name')[0].value;
			const value = row.getElementsByClassName('custom-params-value')[0].value;
			customParams[name] = value;
		});
		return customParams;
	}

	let prefs = {};
	if (window.ipc) {
		prefs = await window.ipc.callMain('get-prefs');
		refreshCustomParamsFields(prefs.searchTypes, prefs.customParams);
	}

	document.getElementById('launch-startup-row').style.display = prefs.launchStartup === null ? 'none' : 'block';
	document.getElementById('launch-startup').checked = prefs.launchStartup;
	document.getElementById('search-types-path').value = prefs.searchTypesPath || '';
	document.getElementById('search-types-order').value = prefs.searchTypesOrder || '';
	if (prefs.accelerator) {
		document.getElementById('accelerator').value = prefs.accelerator;
		document.getElementById('accelerator-display').value = getDisplayKeyStr(prefs.accelerator);
	}

	document.getElementById('accelerator-display').addEventListener('keydown', function(e) {
		let keyStr = getKeyStr(e);
		if (keyStr !== null) {
			if (keyStr === 'Backspace' && document.getElementById('accelerator-display').value !== '') {
				keyStr = '';
			}
			document.getElementById('accelerator').value = keyStr;
			document.getElementById('accelerator-display').value = getDisplayKeyStr(keyStr);
		}
		e.preventDefault();
		e.stopPropagation();
	});

	document.getElementById('button-search-types-open').addEventListener('click', function() {
		const path = document.getElementById('search-types-path').value;
		window.ipc.send('prefs.search-types-open', path);
	});

	document.getElementById('button-search-types-browse').addEventListener('click', async function() {
		const oldPath = document.getElementById('search-types-path').value;
		const result = await window.ipc.callMain('prefs.search-types-browse', { path: oldPath });
		if (result) {
			const { searchTypesPath, searchTypes } = result;
			prefs.searchTypes = searchTypes;
			const searchTypesOrder = searchTypes.map(type => type.id).join(',');
			document.getElementById('search-types-path').value = searchTypesPath;
			document.getElementById('search-types-order').value = searchTypesOrder;
			const customParams = getEnteredCustomParams();
			refreshCustomParamsFields(searchTypes, customParams);
		}
	});

	document.getElementById('button-search-types-order-reset').addEventListener('click', function() {
		document.getElementById('search-types-order').value = prefs.searchTypes.map(type => type.id).join(',');
	});

	document.getElementById('button-cancel').addEventListener('click', function() {
		window.ipc.send('prefs.cancel');
	});

	function submitForm() {
		const customParams = getEnteredCustomParams();
		const launchStartup = document.getElementById('launch-startup').checked;
		const searchTypesPath = document.getElementById('search-types-path').value;
		const searchTypesOrder = document.getElementById('search-types-order').value;
		const accelerator = document.getElementById('accelerator').value;

		if (window.ipc) {
			window.ipc.send('prefs.save', {
				launchStartup,
				searchTypesPath,
				searchTypesOrder,
				accelerator,
				customParams
			});
		}
	}

	document.getElementById('button-ok').addEventListener('click', submitForm);

	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape') {
			window.ipc.send('prefs.cancel');
		} else if (e.key === 'Enter' || e.key === 'Return') {
			submitForm();
		}
	});
})();
</script>
</body>
</html>
